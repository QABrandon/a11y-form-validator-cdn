(function(){'use strict';console.log('üîß A11y Form Validator - Standalone Script Loading... v1.0.22');if(typeof window.jQuery==='undefined'){console.warn('‚ö†Ô∏è jQuery not detected. Enhanced validation features may not work properly.');console.warn('‚ö†Ô∏è Please ensure jQuery and jQuery Validation are loaded before this script.');console.warn('‚ö†Ô∏è Required dependencies:');console.warn(' - https:console.warn(' - https:console.warn(' - https:}else{console.log('‚úÖ jQuery detected,enhanced validation features available');}const BASE_ALLOWED_DOMAINS=[ 'webflow.io','webflow.com','netlify.app','vercel.app','github.io','localhost','127.0.0.1','file:];let dynamicAllowedDomains=[];let domainsLoaded=false;async function fetchCustomDomains(){try{const siteId=window.WEBFLOW_SITE_ID || document.querySelector('meta[name="webflow-site-id"]')?.content || extractSiteIdFromUrl();if(!siteId){console.log('‚ÑπÔ∏è No site ID found,using base allowed domains only');return [];}console.log('üîç Fetching custom domains for site:',siteId);const response=await fetch(`https:method:'GET',headers:{'Content-Type':'application/json',}});if(response.ok){const data=await response.json();const customDomains=data.custom_domains || [];const allDomains=data.domains || [];console.log('‚úÖ Fetched custom domains:',customDomains);console.log('‚úÖ Fetched all domains:',allDomains);const domainNames=[];if(Array.isArray(customDomains)){customDomains.forEach(domain=>{if(typeof domain==='string'){domainNames.push(domain);}else if(domain && domain.name){domainNames.push(domain.name);}});}if(Array.isArray(allDomains)){allDomains.forEach(domain=>{if(typeof domain==='string' && !domainNames.includes(domain)){domainNames.push(domain);}});}return domainNames;}else{console.warn('‚ö†Ô∏è Failed to fetch custom domains,using base domains only');return [];}}catch(error){console.warn('‚ö†Ô∏è Error fetching custom domains:',error);return [];}}function extractSiteIdFromUrl(){const hostname=window.location.hostname;if(hostname.endsWith('.webflow.io')){const siteId=hostname.replace('.webflow.io','');console.log('üîç Extracted site ID from URL:',siteId);return siteId;}return null;}function getAllowedDomains(){return [...BASE_ALLOWED_DOMAINS,...dynamicAllowedDomains];}async function validateDomain(){const hostname=window.location.hostname;if(!domainsLoaded){console.log('üîÑ Loading custom domains from database...');dynamicAllowedDomains=await fetchCustomDomains();domainsLoaded=true;console.log('‚úÖ Custom domains loaded:',dynamicAllowedDomains);}const allowedDomains=getAllowedDomains();const isAllowed=allowedDomains.some(domain=> hostname.includes(domain));if(!isAllowed){console.error('üö´ Unauthorized domain:',hostname);console.warn('A11y Form Validator is only authorized for specific domains');console.warn('Allowed domains:',allowedDomains);return false;}console.log('‚úÖ Domain validation passed:',hostname);return true;}function validateLicense(){const licenseKey=window.A11Y_LICENSE_KEY || document.querySelector('meta[name="a11y-license"]')?.content || document.querySelector('meta[name="a11y-form-validator-license"]')?.content;if(!licenseKey){console.warn('‚ö†Ô∏è No license key found - using fallback validation only');return false;}if(licenseKey.length < 10){console.warn('‚ö†Ô∏è Invalid license key format');return false;}console.log('‚úÖ License validation passed');return true;}async function initializeSecurity(){const domainValid=await validateDomain();if(!domainValid){console.error('üö´ A11y Form Validator blocked - unauthorized domain');return false;}const hasValidLicense=validateLicense();return hasValidLicense;}const SUPABASE_URL=window.SUPABASE_URL || null;const SUPABASE_ANON_KEY=window.SUPABASE_ANON_KEY || null;let validationRulesCache=new Map();let cacheExpiry=new Map();const CACHE_DURATION=5 * 60 * 1000;const errorMessages={required:'This field is required',email:'Please enter a valid email address',phone:'Please enter a valid phone number',url:'Please enter a valid URL',number:'Please enter a valid number',date:'Please enter a valid date',minlength:'Please enter at least{min}characters',maxlength:'Please enter no more than{max}characters'};async function fetchValidationRules(formId){const cacheKey=formId;const now=Date.now();if(validationRulesCache.has(cacheKey)&& cacheExpiry.has(cacheKey)&& now < cacheExpiry.get(cacheKey)){console.log('üìã Using cached validation rules for form:',formId);return validationRulesCache.get(cacheKey);}try{console.log('üîç Fetching validation rules for form:',formId);if(SUPABASE_URL && SUPABASE_ANON_KEY && hasValidLicense){const response=await fetch(`${SUPABASE_URL}/rest/v1/validation_rules?form_id=eq.${formId}&is_active=eq.true&order=order_index.asc`,{headers:{'apikey':SUPABASE_ANON_KEY,'Authorization':`Bearer ${SUPABASE_ANON_KEY}`,'Content-Type':'application/json'}});if(response.ok){const rules=await response.json();console.log('‚úÖ Fetched validation rules from database:',rules.length);const transformedRules=rules.map(rule=>({field_name:rule.field_name,rules:[{rule_type:rule.rule_type,rule_config:rule.rule_config,error_message:rule.error_message,is_active:rule.is_active}]}));validationRulesCache.set(cacheKey,transformedRules);cacheExpiry.set(cacheKey,now + CACHE_DURATION);return transformedRules;}else{console.warn('‚ö†Ô∏è Database fetch failed,falling back to attributes');}}}catch(error){console.warn('‚ö†Ô∏è Failed to fetch validation rules from database:',error);}const rules=await fetchValidationRulesFromAttributes(formId);validationRulesCache.set(cacheKey,rules);cacheExpiry.set(cacheKey,now + CACHE_DURATION);return rules;}async function fetchValidationRulesFromAttributes(formId){const form=document.querySelector(`#${formId}`)|| document.querySelector(`form[name="${formId}"]`)|| document.querySelector(`form[data-a11y-validator="enabled"]`);if(!form){console.warn('‚ö†Ô∏è Form not found for ID:',formId);return [];}const rules=[];const fields=form.querySelectorAll('input,textarea,select');fields.forEach(field=>{const fieldName=field.name || field.id || 'unnamed-field';const fieldRules=[];const hasA11yValidator=field.hasAttribute('data-error-id')|| field.hasAttribute('data-auto-error-messaging')|| field.hasAttribute('data-field-label');if(!hasA11yValidator){console.log('‚ö†Ô∏è Field does not have A11y validator attributes:',fieldName);return;}if(field.hasAttribute('required')){fieldRules.push({rule_type:'required',error_message:`${getFieldLabel(field)}is required`,is_active:true});}if(field.type==='email'){fieldRules.push({rule_type:'email',error_message:'Please enter a valid email address',is_active:true});}if(field.type==='tel'){fieldRules.push({rule_type:'phone',error_message:'Please enter a valid phone number',is_active:true});}if(field.type==='url'){fieldRules.push({rule_type:'url',error_message:'Please enter a valid URL',is_active:true});}const minLength=field.getAttribute('minlength');if(minLength){fieldRules.push({rule_type:'min_length',rule_config:{value:parseInt(minLength)},error_message:`Must be at least ${minLength}characters`,is_active:true});}const maxLength=field.getAttribute('maxlength');if(maxLength){fieldRules.push({rule_type:'max_length',rule_config:{value:parseInt(maxLength)},error_message:`Must be no more than ${maxLength}characters`,is_active:true});}const pattern=field.getAttribute('pattern');if(pattern){fieldRules.push({rule_type:'pattern',rule_config:{pattern:pattern},error_message:'Format is invalid',is_active:true});}if(fieldRules.length > 0){rules.push({field_name:fieldName,rules:fieldRules});}});console.log('üìã Extracted validation rules from attributes:',rules);return rules;}function getFieldLabel(field){const fieldId=field.getAttribute('id');if(fieldId){const labelElement=document.querySelector('label[for="' + fieldId + '"]');if(labelElement && labelElement.textContent.trim()){return labelElement.textContent.trim();}}const ariaLabelledBy=field.getAttribute('aria-labelledby');if(ariaLabelledBy){const labelElement=document.getElementById(ariaLabelledBy);if(labelElement && labelElement.textContent.trim()){return labelElement.textContent.trim();}}const ariaLabel=field.getAttribute('aria-label');if(ariaLabel){return ariaLabel;}const dataLabel=field.getAttribute('data-field-label');if(dataLabel){return dataLabel;}const fieldName=field.getAttribute('name');if(fieldName){return fieldName.replace(/[-_]/g,' ').replace(/\b\w/g,l=> l.toUpperCase());}return 'This field';}function getFieldSpecificMessage(messageType,fieldLabel,context={}){const templates={required:'{fieldLabel}is required',email:'{fieldLabel}must be a valid email address(name@company.com)',phone:'{fieldLabel}must be a valid phone number(US & CA:(555)123-4567)',url:'{fieldLabel}must be a valid URL(https:};let message=templates[messageType] || 'Please check{fieldLabel}';message=message.replace('{fieldLabel}',fieldLabel);message=message.replace('{min}',context.min || '');message=message.replace('{max}',context.max || '');return message;}function getFieldSpecificMessage(messageType,fieldLabel,context={}){const templates={required:'{fieldLabel}is required',email:'{fieldLabel}must be a valid email address(name@company.com)',phone:'{fieldLabel}must be a valid phone number(US & CA:(555)123-4567)',url:'{fieldLabel}must be a valid URL(https:minlength:'{fieldLabel}must be at least{min}characters long',maxlength:'{fieldLabel}must be no more than{max}characters long'};let message=templates[messageType] || 'Please check{fieldLabel}';message=message.replace('{fieldLabel}',fieldLabel);message=message.replace('{min}',context.min || '');message=message.replace('{max}',context.max || '');return message;}function validateField(field){clearFieldError(field);let isValid=true;let errorMessage='';const fieldLabel=getFieldLabel(field);const isAllowedType=field.type==='email' || field.type==='tel' || field.type==='url' || field.type==='text' || field.tagName.toLowerCase()==='textarea';if(!isAllowedType){console.log('‚ÑπÔ∏è Skipping validation for non-allowed field type:',field.type || field.tagName);return true;}if(field.hasAttribute('required')&& !field.value.trim()){isValid=false;errorMessage=getFieldSpecificMessage('required',fieldLabel);}if(field.type==='email' && field.value){const emailRegex=/^[^\s@]+@[^\s@]+\.[^\s@]+$/;if(!emailRegex.test(field.value)){isValid=false;errorMessage=getFieldSpecificMessage('email',fieldLabel);}}if(field.type==='tel' && field.value){const phoneRegex=/^[0-9\s\-\(\)\+]{10,}$/;if(!phoneRegex.test(field.value)){isValid=false;errorMessage=getFieldSpecificMessage('phone',fieldLabel);}}if(field.type==='url' && field.value){try{new URL(field.value);}catch(e){isValid=false;errorMessage=getFieldSpecificMessage('url',fieldLabel);}}if(field.tagName.toLowerCase()==='textarea' && field.hasAttribute('required')&& !field.value.trim()){isValid=false;errorMessage=getFieldSpecificMessage('required',fieldLabel);}if(!isValid && errorMessage){showError(field,errorMessage);}return isValid;}function clearFieldError(field){hideError(field);}function showError(field,message){let errorId=field.getAttribute('data-error-id');if(!errorId){errorId=`a11y-error-${field.name || field.id || 'field'}-${Date.now()}`;field.setAttribute('data-error-id',errorId);}let errorElement=document.getElementById(errorId);if(!errorElement){errorElement=document.createElement('div');errorElement.id=errorId;errorElement.setAttribute('role','alert');errorElement.className='a11y-error-message';const fieldParent=field.parentElement;if(fieldParent){fieldParent.insertBefore(errorElement,field.nextSibling);}}errorElement.textContent=message;errorElement.style.display='block';errorElement.style.color='#721c24';errorElement.style.backgroundColor='#f8d7da';errorElement.style.border='1px solid #f5c6cb';errorElement.style.padding='8px 12px';errorElement.style.borderRadius='4px';errorElement.style.marginTop='8px';errorElement.style.fontSize='14px';errorElement.style.fontWeight='600';errorElement.style.lineHeight='1.4';errorElement.style.fontFamily='-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,sans-serif';field.setAttribute('aria-invalid','true');field.setAttribute('aria-describedby',errorId);console.log('‚úÖ Error message displayed:',message,'for field:',field.name || field.id);}function hideError(field){const errorId=field.getAttribute('data-error-id');if(!errorId)return;const errorElement=document.getElementById(errorId);if(errorElement){errorElement.style.display='none';}field.removeAttribute('aria-invalid');field.removeAttribute('aria-describedby');console.log('‚úÖ Error message hidden for field:',field.name || field.id);}function updateCharacterCount(field){return;}function announceToScreenReader(message){const announcement=document.createElement('div');announcement.setAttribute('aria-live','assertive');announcement.setAttribute('aria-atomic','true');announcement.style.position='absolute';announcement.style.left='-10000px';announcement.style.width='1px';announcement.style.height='1px';announcement.style.overflow='hidden';announcement.textContent=message;document.body.appendChild(announcement);setTimeout(()=>{if(announcement.parentNode){announcement.parentNode.removeChild(announcement);}},1000);}function isValidEmail(email){const emailRegex=/^[^\s@]+@[^\s@]+\.[^\s@]+$/;return emailRegex.test(email);}function isValidPhone(phone){const phoneRegex=/^[\+]?[1-9][\d]{0,15}$/;const cleanPhone=phone.replace(/[\s\-\(\)\.]/g,'');return phoneRegex.test(cleanPhone);}function isValidUrl(url){try{new URL(url);return true;}catch(e){return false;}}function initializeFormValidation(form){const formId=form.id || form.name || 'default';console.log('üîß Initializing validation for form:',formId);form.setAttribute('novalidate','novalidate');console.log('‚úÖ Disabled HTML5 validation for form:',formId);form.addEventListener('invalid',function(e){e.preventDefault();e.stopPropagation();console.log('üö´ Prevented native invalid event for field:',e.target.name || e.target.id);},true);const allFields=form.querySelectorAll('input,textarea,select');console.log('üîç Found',allFields.length,'total fields in form:',formId);allFields.forEach(field=>{if(field.hasAttribute('autofocus')){field.removeAttribute('autofocus');console.log('üîß Removed autofocus from field:',field.name || field.id);}});const fields=[];for(const field of allFields){const isAllowedType=field.type==='email' || field.type==='tel' || field.type==='url' || field.type==='text' || field.tagName.toLowerCase()==='textarea';const hasRequired=field.hasAttribute('required');const hasDataLabel=field.hasAttribute('data-field-label');const hasAutoError=field.hasAttribute('data-auto-error-messaging');if(isAllowedType &&(hasRequired || hasDataLabel || hasAutoError)){fields.push(field);}}console.log('üìã Found',fields.length,'fields that need validation in form:',formId);fields.forEach((field,fieldIndex)=>{const fieldName=field.name || field.id || `field-${fieldIndex}`;if(!field.getAttribute('data-error-id')){const errorId=`a11y-error-${fieldName}-${Date.now()}`;field.setAttribute('data-error-id',errorId);}console.log('üîß Setting up validation for field:',fieldName,'in form:',formId);field.addEventListener('blur',function(){validateField(this);});field.addEventListener('input',function(){clearFieldError(this);});field.addEventListener('focus',function(){clearFieldError(this);});});form.addEventListener('submit',function(e){e.preventDefault();e.stopPropagation();console.log('üîß Form submission intercepted for form:',formId);if(validateForm()){console.log('‚úÖ Form validation passed,submitting form:',formId);form.removeEventListener('submit',arguments.callee);form.submit();}else{console.log('‚ùå Form validation failed for form:',formId);focusFirstError();}});function validateForm(){let isValid=true;let firstErrorField=null;console.log('üîß Validating form with',fields.length,'allowed fields');fields.forEach(field=>{if(!validateField(field)){isValid=false;if(!firstErrorField){firstErrorField=field;}}});if(!isValid && firstErrorField){console.log('‚ùå Form validation failed,first error field:',firstErrorField.name || firstErrorField.id);const allFields=form.querySelectorAll('input,textarea,select');allFields.forEach(field=>{if(field.hasAttribute('autofocus')){field.removeAttribute('autofocus');console.log('üîß Removed autofocus from field:',field.name || field.id);}});announceToScreenReader('Form submission failed. Please correct the errors and try again.');}else{console.log('‚úÖ Form validation passed');}return isValid;}function focusFirstError(){const firstErrorField=form.querySelector('[aria-invalid="true"]');if(firstErrorField){console.log('üîß First error field identified:',firstErrorField.name || firstErrorField.id);const allFields=form.querySelectorAll('input,textarea,select');allFields.forEach(field=>{if(field.hasAttribute('autofocus')){field.removeAttribute('autofocus');console.log('üîß Removed autofocus from field:',field.name || field.id);}});console.log('‚ÑπÔ∏è User should interact with error field naturally');}else{console.log('‚ÑπÔ∏è No error fields found');}}}async function initializeValidation(){const hasValidLicense=await initializeSecurity();const forms=document.querySelectorAll('form');if(forms.length===0){console.log('‚ÑπÔ∏è No forms found on page,skipping validation initialization');return;}console.log('üìã Found',forms.length,'form(s)on page,initializing validation for all forms');forms.forEach(form=>{initializeFormValidation(form);});console.log('‚úÖ A11y Form Validator initialized successfully for',forms.length,'form(s)');}function waitForDOM(){if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',initializeValidation);}else{initializeValidation();}}waitForDOM();})();